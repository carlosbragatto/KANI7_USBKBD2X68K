# 雑多なメモ
本作に関連して気付いた諸々を書き連ねる場です。

ほとんどの方には既知、あるいは何の意味も成さないかも知れません。

---
## キーリピート設定が反映しない!?
`switch.x` でキーリピートの設定を変更するだけではキーボードに反映しないことに気付きました。

今頃気付くなよと言われそうですが、実機を使っていた当時はキーリピートを工場出荷時設定のまま使ってたので...

あれこれ試してみると、`switch.x` で設定するだけでは駄目で、X68k本体を再起動した後に設定が反映されている事が分かりました。

さて、シャープの電子書籍サイトから入手できる X68030/X68030 Compact のサービスマニュアルによれば、
キーボードは自身の起動処理が完了した直後に、スキャンコード `0xff` を本体に送信しているという旨の記述があります。

この `0xff` ですが、キーボード LED の設定を本体に依頼するためのものだそうです。
...本当にその用途だけなのでしょうか?

というわけで、ROM 版数ごとの挙動を確認してみました。

|本体からの|コマンド |機能||R|O|M|の|版|数||
|----------|---------|------------------------|---:|:---|---:|:---|---:|:---|---:|:---|
|          |         |                        |1.3||1.2||1.1||1.0||
|2進       |16進      |                        |IPL|0xff|IPL|0xff|IPL|0xff|IPL|0xff|
|B1xxx_xxxx|0x80～0xff  |LEDの点灯・消灯        |送|送|送|送|送|送|送|送|
|B0101_01xx|0x54～0x57  |LEDの輝度設定          |-|-|-|-|-|-|-|-|
|B0110_xxxx|0x60～0x6f  |キーリピート開始待ち時間|送|送|送|-|送|-|送|-|
|B0111_xxxx|0x70～0x7f  |キーリピート間隔       |送|送|送|-|送|-|送|-|
|B0100_0111|0x47        |Compact keyboard問合せ|-|-|-|-|-|-|-|-|
|B0100_0100|0x44        |NUM解除(ノーマルモード)|-|-|-|-|-|-|-|-|
|B0100_0101|0x45        |NUM設定(テンキーモード)|-|-|-|-|-|-|-|-|
|B0100_1001|0x49		|入力禁止を解除         |送|-|送|-|送|-|送|-|

(セルの横方向結合くらいはサポートして欲しい)

純正キーボードを本体に直結しているなら問題は起きないのですが、
- キーボード変換機が起動完了するより先に設定コマンドが送出された場合
- 途中に KVM スイッチ等が入っているなどで通信経路が繋がっていない場合

などでは、キーリピート設定は当然反映しません。

ツインタワーの本体はキーボードに常時給電しているため、本体のIPL前にキーボード変換機が起動完了している事が確実です。

Compact タイプの場合、本体の電源が入ると同時にキーボードへ給電されるため、キーボード変換機が起動完了するより前に本体から設定コマンドが送出される可能性があります。

ROM 版数1.3、つまり X68030 や X68030 Compact の場合、キーボード変換機が自身の起動後にスキャンコード `0xff` を X68k 本体に送信するようなプログラムになっていれば問題無いでしょう。

なお、PRO や PRO2 については、キーボード端子に VCC1 と VCC2 のどちらが出ているのか確認できていないので、この問題が発生するか否かは分かっていません。

更に余談ですが、こんな事もあろうかと(誇張)、キーリピート設定コマンドを送出させるためのプログラム [`key_rep`](https://github.com/kani7/key_rep/) を用意してあります。困った時に思い出していただければ。

---
## 外からは見えないキーボード関連の信号線 `KEYSET`
別件で回路図を追いかけていた時、キーボードコネクタに見慣れた7本の線の他に、コネクタのシールドとも異なる8本目の線 `KEYSET` があることに気が付きました。

回路図中の『連動スイッチ』という注釈から想像するに、コネクタ自体が接続されているか否かを確認するための信号線のようです。

`KEYSET` の接続先ですが、初代機では BUDDHA、
XVIでは DOSA、X68030 Compact では SAKI のようです。

同じ接続先には `KYREDAY` も繋がってるので、システムポート#4($e8e007)のbit3に関係ありそうです。つまり
- 読取時には `KEYSET` の状態が反映される
- 書き込むと `KYREADY` に反映する

ということではないかと考えているのですが、確認できていません。

---
## キーボード/マウスコネクタ直近のバッファ型名
間違っていたら教えてください

### キーボードコネクタ
|ピン番号|信号名|CZ-600CE(初代)|CZ-634C(XVI)|CZ-500C(030)|CZ-300C(030 compact)|
|----:|---|---|---|---|---|
|2|MSDATA|4.7kΩでプルアップされた後LS367|同左|同左|同左|
|3|KYRXD|LS244|LS244|LS244|10kΩでプルアップされた後2.2kΩを経由してMFP直|
|4|KYTXD|LS244|LS244|LS244|560Ωを経由してMFP直|
|5|KYREADY|74S08|LS244|LS244|LS08|
|6|KYRMT|LS11|LS08|LS08|SAKIの出力とダイオードORされた後イメージユニット端子へ|

### マウスコネクタ
|ピン番号|信号名|CZ-600CE(初代)|CZ-634C(XVI)|CZ-500C(030)|CZ-300C(030 compact)|
|---:|---|---|---|---|----|
|2|MSCTRL|7438|LS486|LS486|同左|
|3|MSDATA|4.7kΩでプルアップされた後LS367|同左|同左|同左|

note:
1. MSDATAは1本の線が単に分岐してマウス/キーボードコネクタの両方に繋がっている
2. ツインタワー機のKYRMTはバッファ手前で10kΩでプルアップされている
3. TTL版のLS244はHC244等と異なりシュミットトリガ入力

---
## SoftwareSerial に関わる諸々
X68kのキーボードの場合、  
- ``KYRxD`` : キーボードから X68k 宛のデータ
- ``MSDATA`` : X68k 宛てのマウスデータ
- ``TVREMOTE`` : テレビコントロール信号

の3種類のデータが送信されます。

本来これら3つは別々のデバイスであって、特に``KYRxD``は  
- ``KYTxD`` : X68k からキーボード宛のデータ(マウス/ LED 制御他)

の状態に関係なくデータを垂れ流すため、USBKBD2X68K では ``KYRxD`` と ``MSDATA`` が同じタイミングでデータを送信し得ます。  
( ``TVREMOTE`` についても似たことが言えますが、ここでは割愛します)

さて、arduino mini pro というか ATmega328P には UART が1系統しかないため、足りない信号は SoftwareSerial を使ってエミュレーションすることになります。  
問題になりそうだと思ったのは以下です:
- SoftwareSerial の送受信データが化ける
- 複数の SoftwareSerial で同時に送信/受信できない
- 処理中に(MsTimer などから)割り込みされると結果がどうなるか記述が見つけられなかった

### SoftwareSerial の送受信データが化ける
規則性がありそうにも見えるのですが、今のところ根本的な対処ができていません。  
USBKBD2X68K の fork の幾つかがピン割り当てを変更しているのはこの理由によるものです。

### 複数の SoftwareSerial で同時に送信/受信できない
これは SoftwareSerial の制限事項です。

拙作の場合はデバッグビルドで挙動不審になり得るという本末転倒な状態なのですが、こういうものだと諦める他ないでしょう。  
USB host sheild と使用ピンが重複してしまうため、AltSoftwareSerial などでの回避もできません。

### 処理中に割り込みされた場合の結果が不明
SoftwareSerial の処理が優先されるなら問題無いのですが、そうでない場合、キーリピート処理中はマウスの挙動が怪しくなります。

まあマウスはおまけ機能ということで。

---
## MsTimer2 を削除した理由
キーリピートのタイミング生成でMsTimer2を使っていたのですが、全く別の箇所で誤動作するためです。  
具体的にはNUMキーをオートリピートしているとハングアップします。なんぞこれ。

---
## 純正マウス・トラックボールは2ボタンマウスではなく4ボタンマウスとして登場したかもしれない話
ツインタワー機付属のマウス・トラックボールである CZ-8MN3 の回路図を作成していた時に気付いたのですが、
4ボタン独立したものとして設計されていたと思しき痕跡があるのです。  
CAD用4ボタンカーソルのようなマウスが登場する未来があったのかもしれません。

---
## ATmega328 + MAX3421E でなくても構わないのでは
かなり良い感じのキーボード変換機を CH559 で作ってしまった方もおられるわけで、仰ることはごもっともなのですが、私個人のプログラミング能力が伴いません。  
個人的には
- RP2040 の USB host 機能を使う、かつ
- USB Hub に接続された USB キーボードを識別する、かつ
- Arduino 環境で使える

ライブラリがあれば、是非とも試したいのですが、そんなピンポイントで都合の良いものが公開されている筈もなく。