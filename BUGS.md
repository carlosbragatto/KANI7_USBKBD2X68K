# 修正予定の無い既知の不都合 (Known issues and bugs those will NOT be fixed)
以下では作者が認識している内、
- 修正予定が無いもの
- 修正優先度が極めて低いもの
- 一見不都合に見えるが仕様であるもの

を列挙しています。  
これらについてはissueを発行しても対処しません。  
pull requestについては都度検討します。

---
## 原作のUSBKBD2X68Kから削除された機能
- Bluetooth対応

---
## 未実装の機能
純正キーボードの機能の内、以下を含むいくつかの機能については実装されていません。
- KYRDY信号(キーボード端子の5番ピン)によるスキャンコード送信の禁止/許可
- テレビコントロールのキー割当をX1相当へ変更する機能
- キーボードLEDを利用した自己診断機能やイースターエッグ

---
## キーリピートの設定が反映されないことがある
### 条件
以下のいずれかの場合。
- X68k本体とUSBKBD2X68Kの間に切替器などが接続されている場合  
- X68000 Compact本体にUSBKBD2X68Kを接続している場合

### 原因
正しくキーリピートの設定が反映されるには、
USBKBD2X68Kが起動した後にキーリピート設定コマンドがX68k本体から送出される必要があります。  
しかし、以下に列挙する複数の原因(仕様)のために、上記条件が揃ってしまうと、この問題が発生します。

#### [原因1] キーリピート設定コマンド送信タイミングの仕様
X68k本体からキーリピート設定コマンドが送信されるのは以下のタイミングです。
- (全機種共通)X68k本体のIPL時
- (X68030の場合)キーボード側からスキャンコード`0xff`が送信された時

後者のタイミングは、純正のキーボード、USBKBD2X68Kともに、自身の起動処理が終了した直後です。

#### [原因2] Compact 型本体の仕様
X68000 Compact XVIおよびX68030 Compactのキーボード端子には常駐電源(VCC2)が出ていません。  
このため、キーボードの起動処理の開始は常に本体の電源ONより後になります。

#### [原因3] `switch.x`の仕様
`switch.x`で設定しただけでは、キーリピート設定コマンドは送信されません。

#### [原因4] キーボードの仕様
純正のキーボード、USBKBD2X68Kともに、X68k本体から送られたキーリピート設定コマンドには従いますが、
その設定値を不揮発性の手段で保存している訳ではありません。  
また、純正のキーボード、USBKBD2X68Kともに、自身の起動処理が完了するまでは一切の制御コマンドに反応しません。

#### [備考] キーボードの起動完了までの時間
純正のキーボードが起動完了に要する時間は約36ms～[41ms](https://twitter.com/haru_ino/status/1512083532407250948/photo/1)のようです。    
拙作の場合、LEDデモを抜いて最短化してもこれに間に合いません。

### 回避策
#### 都度手動で反映する方法
以下のいずれかを実行する。
- X68k本体の電源を切らずに再起動を行う
- 拙作[`key_rep`](https://github.com/kani7/key_rep/)を実行する
- (X68030の場合)USBKBD2X68Kを一旦取り外して、再度接続する
- (X68030の場合)USBKBD2X68Kに搭載されたArduino上のresetボタンを押す

#### ファームウェアの初期値自体を変更する方法
ソース前半部分の
```
#define X68_FIRST_KY  3
#define X68_NEXT_KEY  4
```
の部分を書き換え、ビルドと書き込みを行う。  
数字の意味はそれぞれ`switch.x`の引数である`FIRST_KY`および`NEXT_KEY`と同じです。

---
## X68000 Z EAK付属キーボードをUSB Hubなどを経由して使うことができない
X68000 Z EAK付属のキーボードをUSB HubやUSB切替器、KVMスイッチを経由して接続した場合は動作しません。

UHS2ライブラリがカスケード接続されたUSB Hubをサポートしない事に関係していると思われます。

---
## USB Hubなどを経由した場合に使えないキーボードがある
上述した通りで、有効な対策を見つけられていません。

---
## X68k本体のマウスポートが使用できないことがある
### 条件
本体側マウスポートに接続するマウスの`MSDATA`信号の駆動能力が足りない、  
もしくは純正マウスと同等の構成になっていない。
<!--
### 詳細
X68k本体側にはマウスコネクタ/キーボードコネクタそれぞれに`MSDATA`入力端子があるが、この2つの`MSDATA`端子は内部でワイヤードOR接続されている。
すなわち、相手側がオープンコレクタ出力(またはオープンドレイン出力)かつ、出力側でプルアップされていないことを期待している。

USBKBD2X68Kが使用しているレベル変換回路は偶然にもオープンドレイン出力になっているが、プルアップ抵抗も搭載されている。  
このため、 X68k本体に接続されたマウスが使えるか否かは、そのマウスの回路構成やバス駆動能力次第となってしまう。
-->
### 回避策
USBKBD2X68Kの`MSDATA`信号線(キーボード端子の2番ピン)を接続しない。  
この場合、USB側のマウスは使えなくなる。

---
## テレビコントロール信号の送出中には、それ以外の一切の動作が停止する
### 原因
テレビコントロール信号の生成にタイマーではなく `delayMicroseconds()` を使用しているため。
### [備考] 影響範囲
- テレビコントロール信号を送出している間は、USB接続されたマウスの操作一切が無視される
- テレビコントロール信号を送出している間は、受信バッファに格納できなかった制御コマンドは破棄される
- テレビコントロール信号を送出している間のキー操作は無視される

---
## X68k本体の電源off時にNUM Lockが消灯しない
### 条件
Comapct型以外の本体に接続している場合。
### 原因
以下の仕様によるもの。
- X68k本体が電源off時に制御コード0x44(NUM Lock解除)を送出してこない
- Compact型以外の本体に接続した場合、X68kの電源がoffになってもキーボードの電源は切断されない
### 回避策
なし。純正のCompact用キーボードをCompact型以外の本体に接続した場合も、同じ現象になります。

---
## CTRL+SHIFT+OPT.1を押下し続けてもNUM Lockがオートリピートしない
純正のCompactキーボードでも同じ挙動になります。

---
## CTRL+SHIFT+OPT.1を押下してもNUM Lockのキーコードが送出されない
純正の Compactキーボードでも同じ挙動になります。  
NUMキーを押した場合と異なり、CTRL+SHFT+OPT.1ではキーコード0x74は送出されません。  

---
## MSCTRL信号線の制御コードとして0x40か0x41以外を受け付けない
実機ではCompact用以外の(フルサイズの)キーボードの場合、
 `MSCTRL`信号線の制御コードとしては下から2番目と3番目(4と2の桁)のビットを無視する仕様です。
つまり、0x40～0x47の範囲を受け付けます。

しかし、拙作の場合Compact用キーボードで新設された制御コードである 0x44, 0x45, 0x47 を判別している箇所があるため、`MSCTRL`信号線を制御するには0x40 か0x41を使う必要があります。  

|制御コード(2進)|制御コード(16進)|意味|
|---|---|---|
|B0100_0**x|0x40 ～ 0x47|MSCTRL 信号線の上げ下げ(純正フルキーボードの場合)|
|B0100_000x|0x40 または 0x41|MSCTRL 信号線の上げ下げ(拙作の場合)|
|B0100_010x|0x44 または 0x45|Num解除/設定|
|B0100_0111|0x47|Compactキーボード問い合わせ|

<!--
---
## 約50日間に1度、最大約2秒間ほどキーリピート間隔が変になる
### 原因
内部カウンタが 2^32 ミリ秒 ≒ 49.71日に1回、0に戻るため。
-->
---
## 約72分間に一瞬だけキーリピート間隔が変になる
### 原因
キーリピート処理に利用している内部カウンタが 2^32 マイクロ秒 ≒ 71.58分に1回、0に戻るため

---
## Fnキーを離すタイミング次第で別のスキャンコードが通知される
### 条件
以下の順で操作した場合、4.で通知されるスキャンコードが2.と矛盾する。  
1. Fnキーを押す
2. Fnキーで入れ替わったキーを押す
3. Fnキーを離す
4. 2.で押したキーを離す

### 原因
プログラムの考慮漏れ。以下の順で操作する場合しか考慮していない。
1. Fnキーを押す
2. Fnキーで入れ替わったキーを押す
3. 2.で押したキーを離す
4. Fnキーを離す

### 回避策
複数のキーを押す/離す順が動作に影響するプログラムがある場合、それらのキーを Fnキーで切り替わるキーに割り当てないようにキーバインドを変更する。

---
## NUM Lockキーを無効にしてビルドしても、SHIFT+CTRL+OPT2でキー入力禁止モードが解除される
`ENABLE_NUMKEY` を有効/無効にすることで、Compactキーボード互換機能の有効/無効を切り替えられるようにしていますが、キー入力禁止モードの解除のみ意図的に例外としています。  
どうしても、という方は `sendKeyMake()` 関数を適宜修正してください。

---
## ファームウェアを書き込もうとするとbrown outする場合がある
### 条件
書き込みアダプタの電源容量が少ない場合。

### 回避策
十分な容量の電源を接続した状態でファームウェア書き込みを行う。  
勿論、この回避策を採るか否かに関わらず、**複数の電源が同時に接続されてはならない**。
